@model KTXReportSystem.Models.User
@using KTXReportSystem.Data
@using Microsoft.EntityFrameworkCore
@using System.Text.Json; 
@using KTXReportSystem.Models;
@inject ApplicationDbContext DbContext

@{
    var role = Model.Role;
    var buildings = new List<string> { "K1", "K2", "K3", "K4", "K5", "K6", "A1", "A2", "A3", "A4", "A5" };
    var currentBuilding = Context.Request.Query["building"].FirstOrDefault() ?? "K1";

    var roomStatuses = await DbContext.RoomStatuses.ToListAsync();
    var allOpenReports = await DbContext.Reports.Where(r => r.Status != "Completed" && r.Status != "Canceled").OrderByDescending(r => r.Urgency == "Emergency").ThenBy(r => r.SubmissionDate).ToListAsync();
    var fullHistoryReports = await DbContext.Reports.OrderByDescending(r => r.SubmissionDate).ToListAsync();
    var allTechnicians = await DbContext.Users.Where(u => u.Role == "technician").ToListAsync();
    var techMap = allTechnicians.ToDictionary(u => u.UserIdCode, u => u.FullName);
    var pendingUsers = role == "manager" ? await DbContext.Users.Where(u => u.Role == "Pending").ToListAsync() : new List<User>();

    var buildingStatus = buildings.ToDictionary(b => b, b => 0);
    foreach (var r in allOpenReports) {
        string bCode = (!string.IsNullOrEmpty(r.RoomId) && r.RoomId.Length >= 2) ? r.RoomId.Substring(0, 2).ToUpper() : "";
        if (buildings.Contains(bCode)) {
            int severity = r.Urgency == "Emergency" ? 2 : 1;
            if (severity > buildingStatus[bCode]) buildingStatus[bCode] = severity;
        }
    }
    bool hasNewAssignment = (role == "technician") && allOpenReports.Any(r => r.AssignedToUserIdCode == Model.UserIdCode && r.Status == "Assigned_Technician");
}

<div class="container my-4">
    <h2 class="mb-4 fw-bold text-primary">Bảng Điều Khiển @(role == "manager" ? "Quản Lý" : "Kỹ Thuật")</h2>
    <audio id="notification-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <div class="row g-4">
        <div class="col-xl-4">
            <div class="card mb-4 shadow-lg border-start border-primary border-5">
                <div class="card-body p-3">
                    <h6 class="fw-bold text-primary mb-3">THỐNG KÊ</h6>
                    <div class="d-flex justify-content-between text-center mb-3">
                        <div><h4 class="fw-bold text-primary m-0">@fullHistoryReports.Count</h4><small>Tổng</small></div>
                        <div><h4 class="fw-bold text-success m-0">@fullHistoryReports.Count(r => r.Status == "Completed")</h4><small>Xong</small></div>
                        <div><h4 class="fw-bold text-warning m-0">@allOpenReports.Count(r => r.Status == "Pending_Manager")</h4><small>Chờ</small></div>
                    </div>
                    @if (role == "manager") { <button class="btn btn-outline-primary w-100 btn-sm fw-bold" data-bs-toggle="modal" data-bs-target="#historyModal">Xem Lịch Sử</button> }
                </div>
            </div>
            <div class="card border-danger mb-4 shadow-lg">
                <div class="card-header bg-danger text-white fw-bold small">KHẨN CẤP (ĐANG MỞ)</div>
                <div class="card-body p-0"><ul class="list-group list-group-flush">
                    @foreach (var r in allOpenReports.Where(x => x.Urgency == "Emergency")) {
                        <li class="list-group-item d-flex justify-content-between align-items-center small"><span><strong>@r.RoomId</strong>: @r.Title</span><button class="btn btn-xs btn-outline-danger border-0 view-report" data-bs-report-id="@r.ReportId"><i class="fa-solid fa-eye"></i></button></li>
                    }</ul></div>
            </div>
            @if (role == "manager") {
                <div class="card border-warning shadow-lg"><div class="card-header bg-warning text-dark fw-bold small">CHỜ DUYỆT (@allOpenReports.Count(r => r.Status == "Pending_Manager"))</div><div class="card-body p-0"><ul class="list-group list-group-flush">
                    @foreach (var r in allOpenReports.Where(r => r.Status == "Pending_Manager")) { <li class="list-group-item d-flex justify-content-between align-items-center small"><span><strong>@r.RoomId</strong>: @r.Title</span><button class="btn btn-xs btn-outline-warning text-dark border-0 view-report" data-bs-report-id="@r.ReportId"><i class="fa-solid fa-eye"></i></button></li> }
                </ul></div></div>
            } else {
                <div class="card border-info shadow-lg"><div class="card-header bg-info text-white fw-bold small">NHIỆM VỤ CỦA TÔI</div><div class="card-body p-0"><ul class="list-group list-group-flush">
                    @foreach (var r in allOpenReports.Where(r => r.AssignedToUserIdCode == Model.UserIdCode)) { <li class="list-group-item d-flex justify-content-between align-items-center small"><span><strong>@r.RoomId</strong>: @r.Title</span><button class="btn btn-xs btn-outline-info text-dark border-0 view-report" data-bs-report-id="@r.ReportId"><i class="fa-solid fa-eye"></i></button></li> }
                </ul></div></div>
            }
        </div>

        <div class="col-xl-8">
             @if (role == "manager" && pendingUsers.Any()) {
                <div class="card shadow-lg mb-4 border-success"><div class="card-header bg-success text-white fw-bold">XÉT DUYỆT TÀI KHOẢN (@pendingUsers.Count)</div><div class="card-body p-0"><table class="table table-hover mb-0 align-middle"><tbody>
                    @foreach (var u in pendingUsers) { <tr><td class="fw-bold">@u.UserIdCode</td><td>@u.FullName</td><td><button class="btn btn-sm btn-outline-primary view-user me-1" data-bs-user-id="@u.Id"><i class="fa-solid fa-eye"></i></button><form method="post" class="d-inline"><input type="hidden" name="UserId" value="@u.Id" /><button type="submit" asp-page-handler="ApproveUser" class="btn btn-sm btn-success"><i class="fa-solid fa-check"></i></button><button type="submit" asp-page-handler="RejectUser" class="btn btn-sm btn-danger" onclick="return confirm('Xóa?')"><i class="fa-solid fa-times"></i></button></form></td></tr> }
                </tbody></table></div></div>
             }
             <div class="card shadow-lg p-4">
                <h5 class="fw-bold mb-3">Sơ đồ KTX</h5>
                <div class="mb-4 d-flex flex-wrap gap-2">
                    @foreach (var b in buildings) {
                        var st = buildingStatus.GetValueOrDefault(b, 0);
                        string cls = st==2?"btn-danger urgent-flash":st==1?"btn-warning":"btn-secondary text-white-50";
                        if(currentBuilding==b) cls+=" border-2 border-dark shadow";
                        <a href="?building=@b" class="btn btn-sm fw-bold rounded-pill px-3 @cls">@b</a>
                    }
                </div>
                <div class="border rounded p-3 bg-light shadow-sm"><h6 class="fw-semibold mb-3">Tòa @currentBuilding</h6>
                     @for (int f = 5; f >= 1; f--) {
                        <div class="mb-3 border-bottom pb-2 d-flex"><span class="me-2 fw-bold">Tầng @f</span><div class="d-flex flex-wrap gap-1">
                                @for (int n = 1; n <= 14; n++) {
                                    var rid = $"{currentBuilding}{f}{n:00}";
                                    var hasUrgent = allOpenReports.Any(r => r.RoomId == rid && r.Urgency == "Emergency");
                                    var cnt = allOpenReports.Count(r => r.RoomId == rid);
                                    string bg = hasUrgent?"bg-danger urgent-flash text-white":(cnt>0?"bg-warning text-dark":"bg-success text-white");
                                    <button class="btn btn-sm text-center fw-bold rounded shadow-sm @bg room-tile text-nowrap p-0" style="width: 50px; height: 32px; line-height: 30px;" data-bs-room-id="@rid">@(f)@n.ToString("00") @if(cnt > 0){<span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-dark" style="font-size: 0.6rem;">@cnt</span>}</button>
                                }
                        </div></div>
                     }
                </div>
             </div>
        </div>
    </div>
</div>

<!-- MODAL CHI TIẾT -->
<div class="modal fade" id="reportDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title" id="reportDetailModalLabel">Chi Tiết</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
        <div class="mb-3 p-3 bg-light rounded border">
            <div class="row">
                <div class="col-md-6"><p class="mb-1"><strong>Phòng:</strong> <span id="modal-room" class="fw-bold fs-5"></span></p><p class="mb-1"><strong>Mức độ:</strong> <span id="modal-urgency"></span></p></div>
                <div class="col-md-6"><p class="mb-1"><strong>Người xử lý:</strong> <span id="modal-tech-name" class="fw-bold text-primary"></span></p></div>
            </div>
            <hr class="my-2"/>
            <p class="mb-1"><strong>Tiêu đề:</strong> <span id="modal-title" class="fw-bold"></span></p>
            <p class="mb-1"><strong>Mô tả:</strong> <span id="modal-description"></span></p>
            <p class="mb-1 d-none" id="evidence-row"><strong>Minh chứng:</strong> <a href="#" target="_blank" id="modal-evidence-link" class="text-primary text-decoration-underline"><i class="fa-solid fa-image me-1"></i> Xem Ảnh/Video</a></p>
            <p class="mb-1 d-none mt-2" id="tech-update-display"><strong><i class="fa-solid fa-wrench me-1"></i> Cập nhật KTV:</strong> <span id="modal-tech-update-text-display" class="fst-italic text-info"></span></p>
        </div>
        <hr />
        <div id="no-action-msg" class="alert alert-secondary text-center d-none">Chỉ xem.</div>
        <form id="form-manager-assign" method="post" asp-page-handler="AssignReport" class="d-none"><input type="hidden" name="ReportId" id="assign-report-id" /><div class="mb-3"><label class="fw-bold">Gán cho:</label><select name="AssignedToUserIdCode" class="form-select">@foreach (var t in allTechnicians) { <option value="@t.UserIdCode">@t.FullName</option> }</select></div><button type="submit" class="btn btn-success me-2">Phân công</button><button type="submit" class="btn btn-danger" asp-page-handler="CancelReport" onclick="return confirm('Hủy?')">Hủy</button></form>
        <form id="form-tech-update" method="post" asp-page-handler="UpdateStatus" class="d-none"><input type="hidden" name="ReportId" id="update-report-id" /><div class="mb-3"><label class="fw-bold">Tiến độ:</label><textarea name="TechnicianUpdate" id="modal-tech-update-text" class="form-control" rows="2"></textarea></div><div class="mb-3"><label class="fw-bold">Trạng thái:</label><select name="NewStatus" id="modal-new-status-select" class="form-select"><option value="Assigned_Technician">Đã tiếp nhận</option><option value="In_Progress">Đang xử lý</option><option value="On_Hold">Tạm hoãn</option></select></div><button type="submit" class="btn btn-info text-white">Cập nhật</button></form>
        <form id="form-tech-complete" method="post" asp-page-handler="CompleteReport" class="mt-3 border-top pt-3 d-none"><input type="hidden" name="ReportId" id="complete-report-id" /><button type="submit" class="btn btn-success w-100 fw-bold" onclick="return confirm('Xong?')">HOÀN THÀNH</button></form>
    </div></div></div>
</div>

<!-- MODAL LỊCH SỬ -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header bg-dark text-white"><h5 class="modal-title">Lịch Sử</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><div class="table-responsive" style="max-height: 60vh;"><table class="table table-striped table-hover mb-0"><thead class="table-secondary sticky-top"><tr><th>Ngày</th><th>Phòng</th><th>Tiêu đề</th><th>KTV</th><th>Trạng thái</th><th>Xem</th></tr></thead><tbody>
    @foreach (var r in fullHistoryReports) {
        <tr><td>@r.SubmissionDate.ToString("dd/MM HH:mm")</td><td><span class="badge bg-light text-dark border">@r.RoomId</span></td><td>@if(r.Urgency=="Emergency"){<i class="fa-solid fa-fire text-danger"></i>} @r.Title</td>
        <td>@(r.AssignedToUserIdCode!=null && techMap.ContainsKey(r.AssignedToUserIdCode)?techMap[r.AssignedToUserIdCode]:"-")</td>
        <td>@if(r.Status=="Completed"){<span class="badge bg-success">Xong</span>}else if(r.Status=="Canceled"){<span class="badge bg-secondary">Hủy</span>}else{<span class="badge bg-warning text-dark">Đang xử lý</span>}</td>
        <td><button class="btn btn-sm btn-outline-primary view-report" data-bs-report-id="@r.ReportId"><i class="fa-solid fa-eye"></i></button></td></tr>
    }
</tbody></table></div></div></div></div></div>

<!-- MODAL USER -->
<div class="modal fade" id="userDetailModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Sinh Viên</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><h4 id="user-modal-fullname" class="fw-bold text-center"></h4><ul class="list-group list-group-flush mt-3"><li class="list-group-item">Mã SV: <span id="user-modal-code" class="fw-bold"></span></li><li class="list-group-item">Vị trí: Tòa <span id="user-modal-building" class="badge bg-info"></span> - Phòng <span id="user-modal-room" class="badge bg-primary"></span></li><li class="list-group-item">Thông tin: <span id="user-modal-info"></span></li></ul><input type="hidden" id="user-modal-id" /></div></div></div></div>

<script>
    const allReports = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(fullHistoryReports));
    const pendingUsers = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(pendingUsers));
    const allTechs = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(allTechnicians));
    const role = "@Model.Role";
    const myId = "@(Model.UserIdCode ?? "")".toLowerCase();

    function populateReportModal(reportId) {
        const hm = bootstrap.Modal.getInstance(document.getElementById('historyModal')); if(hm) hm.hide();
        const r = allReports.find(x => x.ReportId.toString() === reportId.toString()); if(!r) return;

        document.getElementById('reportDetailModalLabel').textContent = `Báo Cáo #${r.ReportId}`;
        document.getElementById('modal-room').textContent = r.RoomId;
        document.getElementById('modal-title').textContent = r.Title;
        document.getElementById('modal-description').textContent = r.Description;
        document.getElementById('modal-urgency').textContent = r.Urgency==='Emergency'?'Khẩn cấp':'Thường';
        document.getElementById('modal-urgency').className = r.Urgency==='Emergency'?'badge bg-danger':'badge bg-warning text-dark';

        let tName = "Chưa phân công";
        if (r.AssignedToUserIdCode) { const t = allTechs.find(x => x.UserIdCode === r.AssignedToUserIdCode); if (t) tName = t.FullName; }
        document.getElementById('modal-tech-name').textContent = tName;

        const eRow = document.getElementById('evidence-row');
        const eLink = document.getElementById('modal-evidence-link');
        if (r.EvidenceBase64) { eLink.href = r.EvidenceBase64; eRow.classList.remove('d-none'); } else { eRow.classList.add('d-none'); }

        const tRow = document.getElementById('tech-update-display');
        if (r.TechnicianUpdate) { document.getElementById('modal-tech-update-text-display').textContent = r.TechnicianUpdate; tRow.classList.remove('d-none'); } else { tRow.classList.add('d-none'); }

        const fM = document.getElementById('form-manager-assign');
        const fT = document.getElementById('form-tech-update');
        const fC = document.getElementById('form-tech-complete');
        const msg = document.getElementById('no-action-msg');
        fM.classList.add('d-none'); fT.classList.add('d-none'); fC.classList.add('d-none'); msg.classList.add('d-none');

        let showAction = false;
        if (role === 'manager' && r.Status !== 'Completed' && r.Status !== 'Canceled') {
            fM.classList.remove('d-none'); document.getElementById('assign-report-id').value = r.ReportId; showAction = true;
        } else if (role === 'technician' && r.Status !== 'Completed' && r.Status !== 'Canceled') {
             const isMe = r.AssignedToUserIdCode && r.AssignedToUserIdCode.toLowerCase() === myId;
             if (isMe || r.Urgency === 'Emergency') {
                fT.classList.remove('d-none'); fC.classList.remove('d-none');
                document.getElementById('update-report-id').value = r.ReportId;
                document.getElementById('complete-report-id').value = r.ReportId;
                document.getElementById('modal-tech-update-text').value = r.TechnicianUpdate || '';
                document.getElementById('modal-new-status-select').value = r.Status;
                showAction = true;
             }
        }
        if (!showAction) msg.classList.remove('d-none');
        new bootstrap.Modal(document.getElementById('reportDetailModal')).show();
    }

    function populateUserModal(userId) {
        const u = pendingUsers.find(x => x.Id.toString() === userId.toString()); if(!u) return;
        document.getElementById('user-modal-fullname').textContent = u.FullName;
        document.getElementById('user-modal-code').textContent = u.UserIdCode;
        const rid = u.RoomId || "";
        document.getElementById('user-modal-building').textContent = rid.length >= 2 ? rid.substring(0, 2) : "?";
        document.getElementById('user-modal-room').textContent = rid.length > 2 ? rid.substring(2) : rid;
        document.getElementById('user-modal-info').textContent = u.StudentInfo;
        new bootstrap.Modal(document.getElementById('userDetailModal')).show();
    }

    document.addEventListener('DOMContentLoaded', () => {
        const audio = document.getElementById('notification-sound');
        if(audio && @Html.Raw(hasNewAssignment.ToString().ToLower())) audio.play().catch(e=>{});
        document.body.addEventListener('click', e => {
            const btnR = e.target.closest('.view-report');
            const btnTile = e.target.closest('.room-tile');
            if (btnR) populateReportModal(btnR.dataset.bsReportId);
            else if (btnTile) {
                const r = allReports.find(x => x.RoomId === btnTile.dataset.bsRoomId && x.Status !== 'Completed' && x.Status !== 'Canceled');
                if(r) populateReportModal(r.ReportId);
            }
            const btnU = e.target.closest('.view-user');
            if(btnU) populateUserModal(btnU.dataset.bsUserId);
        });
    });
</script>